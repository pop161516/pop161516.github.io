<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Assignment3</title>
    <link rel="stylesheet" href="reset.css" />
    <link rel="stylesheet" href="style.css" />
    <style>
      .center-button {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 15px 30px;
        font-size: 1.2em;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        z-index: 100;
        display: none;
      }

      .vid {
        height: 200vh;
        overflow: hidden;
        position: relative;
      }

      .holder video {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
    </style>
  </head>
  <body>
    <section class="vid">
      <div class="holder">
        <video id="myVideo" muted loop playsinline>
          <source src="vid.mp4" type="video/mp4" />
        </video>
      </div>
    </section>

    <button id="changeVideoButton" class="center-button">
      Explore Equiptment rental
    </button>

    <script>
      const section = document.querySelector("section.vid");
      const vid = document.getElementById("myVideo");
      const changeVideoButton = document.getElementById("changeVideoButton");

      const initialVideoSource = "vid.mp4";
      const newVideoSource = "new_vid.mp4";

      function scroll() {
        if (
          !vid ||
          isNaN(vid.duration) ||
          vid.duration === 0 ||
          vid.readyState < 2
        ) {
          console.warn("Video not ready â€” skipping scroll sync.");
          return;
        }

        const distance = window.scrollY - section.offsetTop;
        const total = section.clientHeight - window.innerHeight;
        let percentage = Math.max(0, Math.min(1, distance / total));

        vid.currentTime = vid.duration * percentage;

        const currentSrc =
          vid.querySelector("source")?.getAttribute("src") || "";

        const atEndOfInitial =
          currentSrc.includes(initialVideoSource) && percentage >= 0.98;
        const atStartOfNew =
          currentSrc.includes(newVideoSource) && percentage <= 0.02;

        if (atEndOfInitial || atStartOfNew) {
          changeVideoButton.style.display = "block";
        } else {
          changeVideoButton.style.display = "none";
        }
      }

      function switchVideo(src, buttonLabel) {
        vid.pause();

        // Replace <source> and reload
        vid.innerHTML = `<source src="${src}" type="video/mp4">`;
        vid.load();

        changeVideoButton.textContent = buttonLabel;
        changeVideoButton.style.display = "none";

        // Scroll to top and wait for metadata to load
        window.scrollTo({ top: 0 });
      }

      changeVideoButton.addEventListener("click", () => {
        const currentSrc =
          vid.querySelector("source")?.getAttribute("src") || "";
        if (currentSrc.includes(initialVideoSource)) {
          switchVideo(newVideoSource, "Explore Equiptment rental");
        } else {
          switchVideo(initialVideoSource, "???");
        }
      });

      vid.addEventListener("loadedmetadata", () => {
        console.log("--- loadedmetadata event fired! ---");
        scroll(); // Now it's safe to calculate video duration
      });

      // Initial setup
      window.addEventListener("scroll", scroll);
      window.addEventListener("DOMContentLoaded", scroll); // Just in case
    </script>
  </body>
</html>
